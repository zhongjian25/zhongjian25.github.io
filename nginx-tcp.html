<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="云运维">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="https://www.172173.com">
    <!--SEO-->

    <meta name="keywords" content="nginx tcp">


    <meta name="description" content="
wriren by: CQhttps://www.920430.comwriren time: 2017-7-4 15:52:2
Nginx TCP AND UDP LOAD BALANCER...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>nginx-tcp | 云运维</title>


    <link rel="alternate" href="/atom.xml" title="云运维" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>





	<script>
		(function(i, s, o, g, r, a, m) {
		    i['GoogleAnalyticsObject'] = r;
		    i[r] = i[r] || function() {
		        (i[r].q = i[r].q || []).push(arguments)
		    }, i[r].l = 1 * new Date();
		    a = s.createElement(o),
		    m = s.getElementsByTagName(o)[0];
		    a.async = 1;
		    a.src = g;
		    m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
		ga('create', 'UA-139064963-1', 'auto');
		ga('send', 'pageview');
	</script>


    

    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-7288533661448713",
          enable_page_level_ads: true
      });
    </script>
</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header" style="background-image:url(https://res.cloudinary.com/www-172173-com/image/upload/v1556197753/banner_y3vilj.jpg)">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="zj">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 越努力越幸运 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://www.172173.com">云运维</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/运维/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/自动化/"><i class="fa "></i>自动化</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/工具/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>时间轴</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="nginx-tcp">
            
	            nginx-tcp
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/运维/">运维</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/nginx-tcp/">nginx tcp</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/04/26</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>
            
            
    </div>
    
    <div class="post-body post-content">
        <hr>
<p><strong><em>wriren by: CQ</em></strong><br><strong><em><a href="https://www.920430.com">https://www.920430.com</a></em></strong><br><strong><em>wriren time: 2017-7-4 15:52:2</em></strong></p>
<h1 id="Nginx-TCP-AND-UDP-LOAD-BALANCER"><a href="#Nginx-TCP-AND-UDP-LOAD-BALANCER" class="headerlink" title="Nginx TCP AND UDP LOAD BALANCER"></a><strong><em>Nginx TCP AND UDP LOAD BALANCER</em></strong></h1><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html">官方文档 1: ngx_stream_proxy_module</a></p>
<p><a href="https://www.nginx.com/resources/admin-guide/tcp-load-balancing/">官方文档 2: tcp-load-balancing</a></p>
<p><a href="http://hansionxu.blog.163.com/blog/static/24169810920150191131221/">Nginx的TCP负载均衡介绍  </a></p>
<p><a href="https://severalnines.com/blog/nginx-database-load-balancer-mysql-or-mariadb-galera-cluster">nginx-database-load-balancer-mysql-or-mariadb-galera-cluster  </a></p>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Nginx从Nginx Plus(商业授权版) 1.7.7 开始支持 TCP和UDP的负载均衡;Nginx开源版本从1.9.0起开始支持TCP的负载均衡，从1.9.13版本开始支持UDP和UNIX-domain sockets。</p>
<p>Nginx开源版本默认没有开启TCP负载均衡，开启需要在编译构建的时候新增–with-stream 参数，而Nginx Plus则默认就已经开启不需要额外参数。</p>
<p>下面是几个简单的Nginx配置(Example Configuration)</p>
<ul>
<li><p>TCP</p>
<pre><code>server {
    listen 127.0.0.1:12345;
    proxy_pass 127.0.0.1:8080;
}

server {
    listen 12345;
    proxy_connect_timeout 1s;
    proxy_timeout 1m;
    proxy_pass example.com:12345;
}
</code></pre></li>
<li><p>UDP</p>
<pre><code>server {
    listen 53 udp;
    proxy_responses 1;
    proxy_timeout 20s;
    proxy_pass dns.example.com:53;
}
</code></pre></li>
<li><p>UNIX-domain sockets</p>
<pre><code>server {
    listen [::1]:12345;
    proxy_pass unix:/tmp/stream.socket;
}
</code></pre></li>
</ul>
<hr>
<h2 id="Nginx-TCP负载均衡算法"><a href="#Nginx-TCP负载均衡算法" class="headerlink" title="Nginx TCP负载均衡算法"></a>Nginx TCP负载均衡算法</h2><p>与Nginx http负载均衡一样，Nginx TCP负载均衡也支持如下负载均衡算法：</p>
<ol>
<li><p>Round Robin: 对所有的backend轮询发送请求，算是最简单的方式了，也是默认的分配方式；例如：</p>
<pre><code>upstream stream_backend {
    server backend1.example.com:12345;
    server backend2.example.com:12345;
    server backend3.example.com:12346;
    ...
}
</code></pre></li>
</ol>
<ol start="2">
<li><p>Least Connections(least_conn): 跟踪和backend当前的活跃连接数目，最少的连接数目说明这个backend负载最轻，将请求分配给他，这种方式会考虑到配置中给每个upstream分配的weight权重信息；例如：</p>
<pre><code>upstream dns_servers {
    least_conn;
    server 192.168.136.130:53;
    server 192.168.136.131:53;
    ...
}
</code></pre></li>
<li><p>Least Time(least_time): 请求会分配给响应最快和活跃连接数最少的backend；(该算法目前仅在Nginx Plus上支持)；例如：</p>
<pre><code>upstream stream_backend {
    least_time first_byte;

    server backend1.example.com:12345;
    server backend2.example.com:12345;
    server backend3.example.com:12346;
}
</code></pre></li>
<li><p>Hash(hash key): client-server基于hash key计算hash值后,根据得到的hash值通过某种映射分配到backend。key值可以包括text, variables。例如：</p>
<pre><code>upstream stream_backend {
    hash $remote_addr;

    server backend1.example.com:12345;
    server backend2.example.com:12345;
    server backend3.example.com:12346;
}
</code></pre></li>
</ol>
<hr>
<h2 id="Nginx-TCP健康检查"><a href="#Nginx-TCP健康检查" class="headerlink" title="Nginx TCP健康检查"></a>Nginx TCP健康检查</h2><p>开源版本的Nginx软件可以对上游服务器(upstream servers)的响应执行基本检查，尽可能重试失败的请求（也称为Passive Health Checks）。 NGINX Plus则额外增加了对外部应用程序运行状况检查（也称为Active Health Checks）和检查缓慢启动功能(slow‑start)，可以对负载平衡组中新增和恢复的服务器正常添加。</p>
<h3 id="Passive-Health-Checks"><a href="#Passive-Health-Checks" class="headerlink" title="Passive Health Checks:"></a>Passive Health Checks:</h3><p>Passive Health Checks (被动健康检查)意味着NGINX或NGINX Plus会监控服务通信是否可用，如果不可用，NGINX将尝试恢复。如果仍然无法恢复，NGINX会考虑该服务不可用，并暂时停止向该服务器发送请求，直到被再次被视为活动。</p>
<p>Nginx和Nginx Plus都支持下面指令，来判断服务是否不可用：</p>
<ul>
<li>fail_timeout - 设置考虑服务器不可用的多次失败尝试的时间，以及服务器不可用的时间（默认为10秒）。</li>
<li>max_fails - 在fail_timeout时间内设置失败尝试次数，以考虑服务器不可用（默认为1连接）尝试。</li>
</ul>
<p><strong>例1</strong></p>
<p>该示例显示，如果NGINX无法向某个服务器发送请求或至少三次未收到此服务器的响应，则立即认为该服务器不可用30秒：</p>
<pre><code>upstream backend {
    server backend1.example.com;
    server backend2.example.com max_fails=3 fail_timeout=30s;
}
</code></pre><p><strong>例2</strong></p>
<p>在该例显示，假设有7个连接，那么有5个连接将转到backend1.example.com:12345(因为权重为5，weight=5)，剩下的连接到第二和第三个服务器。如果在与服务器通信期间发生错误，则连接将被传递到下一个服务器，依此类推，直到所有正在运行的服务器都将被尝试。 如果与所有服务器的通信失败，则连接将关闭。</p>
<pre><code>upstream backend {
    server backend1.example.com:12345 weight=5;
    server 127.0.0.1:12345            max_fails=3 fail_timeout=30s;
    server unix:/tmp/backend2;
    server backend3.example.com:12345 resolve;

    server backup1.example.com:12345  backup;
}
</code></pre><h3 id="Active-Health-Checks"><a href="#Active-Health-Checks" class="headerlink" title="Active Health Checks"></a>Active Health Checks</h3><p>NGINX Plus可以通过使用health_check指令包含在位置块中来配置最简单的运行状况检查。，并检查响应。</p>
<p><strong>例1</strong></p>
<p>以下示例 - 向每个服务发送带自定义的TCP请求。 返回良好的200的服务器被认为是健康的; 否则它们被标记为失败。</p>
<pre><code>stream {
    ...
    upstream   stream_backend {
        zone   upstream_backend 64k;
        server backend1.example.com:12345;
    }

    match http {
        send      &quot;GET / HTTP/1.0\r\nHost: localhost\r\n\r\n&quot;;
        expect ~* &quot;200 OK&quot;;
    }

    server {
    listen       12345;
    health_check match=http;
    proxy_pass   stream_backend;
    }
}
</code></pre><h3 id="更多health-check参考资料"><a href="#更多health-check参考资料" class="headerlink" title="更多health-check参考资料"></a>更多health-check参考资料</h3><p><a href="https://www.nginx.com/resources/admin-guide/http-health-check/">http-health-check</a></p>
<p><a href="https://www.nginx.com/resources/admin-guide/tcp-health-check/">tcp-health-check</a></p>
<hr>
<h2 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h2><p>都在一个机器上， Nginx监听30003端口，然后开两个窗口，用nc监听 7773，7774端口。思路如下：</p>
<pre><code>                          / nc -l 7773
telnet--&gt; Nginx(30003) --&gt;
                          \ nc -l 7774
</code></pre><p>使用nc监听端口</p>
<pre><code>$  nc -l 7773
$  nc -l 7774
</code></pre><p>Nginx配置</p>
<pre><code>stream {
    upstream backend {
        server 127.0.0.1:7773;
        server 127.0.0.1:7774;
    }
    server {
        listen 127.0.0.1:30003;
        proxy_timeout 20s;
        proxy_pass backend;
    }
}
</code></pre><p>测试</p>
<pre><code>$ telnet 127.0.0.1 30003
</code></pre><p>第一次访问会代理到 7773端口，第二次访问会到7774端口。</p>
<hr>
<h2 id="线上配置文件"><a href="#线上配置文件" class="headerlink" title="线上配置文件"></a>线上配置文件</h2><pre><code>stream {
    upstream stream_backend {
        least_conn;
        server 127.0.0.1:8801 max_fails=2 fail_timeout=30s;
        server 127.0.0.1:8802 max_fails=2 fail_timeout=30s;
        server 127.0.0.1:8803 max_fails=2 fail_timeout=30s;
    }
    server {
        listen 8800;
        proxy_timeout 10m;
        proxy_connect_timeout 60;
        proxy_pass stream_backend;
    }
}
</code></pre><p><strong>PS： 如果upstream组中只有一个服务器，max_fails，fail_timeout和slow_start参数都将被忽略，并且这样的服务器将永远不会被视为不可用。</strong></p>
<hr>

    </div>
    
        <div class="reward" ontouchstart>
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            
                <span class="reward-type">
                    <img class="wechat" src="../../../../img/reward-wepay.png"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">赞赏是不耍流氓的鼓励</p>
</div>


    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href target="_blank">Snippet</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/nginx-rewrite.html" class="pre-post btn btn-default" title="nginx-rewrite">
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">nginx-rewrite</span>
        </a>
    
    
        <a href="/nginx-install.html" class="next-post btn btn-default" title="nginx-install">
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">nginx-install</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


<!--<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-7288533661448713",
    enable_page_level_ads: true
  });
</script>
-->


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'xFcujt6m2KQvPvjBxRVRiD6R-gzGzoHsz',
            appKey: 'wn426D29iJpKjYczYLBPPCiP',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-TCP-AND-UDP-LOAD-BALANCER"><span class="toc-text">Nginx TCP AND UDP LOAD BALANCER</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文档"><span class="toc-text">参考文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-TCP负载均衡算法"><span class="toc-text">Nginx TCP负载均衡算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-TCP健康检查"><span class="toc-text">Nginx TCP健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Passive-Health-Checks"><span class="toc-text">Passive Health Checks:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Active-Health-Checks"><span class="toc-text">Active Health Checks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更多health-check参考资料"><span class="toc-text">更多health-check参考资料</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单测试"><span class="toc-text">简单测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线上配置文件"><span class="toc-text">线上配置文件</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<span>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>



</span>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>

            </div>
            <div class="col-sm-12">
               
                <span>Copyright &copy; 2019
                </span> |
                 <span>
                版权所有 <a href="//beian.miit.gov.cn" class="copyright-links" target="_blank" rel="nofollow">闽IC
P备18011948号</a>
        	</span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>






    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>